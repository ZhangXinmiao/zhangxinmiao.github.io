<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="性能指标工具React PerfReact 官方为我们提供的性能指标工具 Perf (只适用于开发模式)
我们有两种方式使用它
ps:两种方式都需要在项目Perf插件123import Perf from &apos;react-addons-perf&apos; // ES6var Perf = require(&apos;react-addons-perf&apos;) // ES5 with npmvar Perf = React">
<meta property="og:type" content="article">
<meta property="og:title" content="React 性能优化初探">
<meta property="og:url" content="http://zhangxinmiao.com/2017/02/21/betterreact/index.html">
<meta property="og:site_name" content="ZhangXinmiao's blog">
<meta property="og:description" content="性能指标工具React PerfReact 官方为我们提供的性能指标工具 Perf (只适用于开发模式)
我们有两种方式使用它
ps:两种方式都需要在项目Perf插件123import Perf from &apos;react-addons-perf&apos; // ES6var Perf = require(&apos;react-addons-perf&apos;) // ES5 with npmvar Perf = React">
<meta property="og:image" content="http://zhangxinmiao.com/2017/02/21/betterreact/0.png">
<meta property="og:image" content="http://zhangxinmiao.com/2017/02/21/betterreact/1.png">
<meta property="og:image" content="http://zhangxinmiao.com/2017/02/21/betterreact/2.gif">
<meta property="og:image" content="http://zhangxinmiao.com/2017/02/21/betterreact/3.png">
<meta property="og:image" content="http://zhangxinmiao.com/2017/02/21/betterreact/4.jpg">
<meta property="og:image" content="http://zhangxinmiao.com/2017/02/21/betterreact/5.gif">
<meta property="og:image" content="http://zhangxinmiao.com/2017/02/21/betterreact/6.png">
<meta property="og:image" content="http://zhangxinmiao.com/2017/02/21/betterreact/7.png">
<meta property="og:image" content="http://zhangxinmiao.com/2017/02/21/betterreact/8.png">
<meta property="og:image" content="http://zhangxinmiao.com/2017/02/21/betterreact/9.png">
<meta property="og:image" content="http://zhangxinmiao.com/2017/02/21/betterreact/10.gif">
<meta property="og:image" content="http://zhangxinmiao.com/2017/02/21/betterreact/11.gif">
<meta property="og:image" content="http://zhangxinmiao.com/2017/02/21/betterreact/12.png">
<meta property="og:image" content="http://zhangxinmiao.com/2017/02/21/betterreact/13.png">
<meta property="og:image" content="http://zhangxinmiao.com/2017/02/21/betterreact/14.png">
<meta property="og:image" content="http://zhangxinmiao.com/2017/02/21/betterreact/15.png">
<meta property="og:updated_time" content="2017-02-22T04:10:18.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="React 性能优化初探">
<meta name="twitter:description" content="性能指标工具React PerfReact 官方为我们提供的性能指标工具 Perf (只适用于开发模式)
我们有两种方式使用它
ps:两种方式都需要在项目Perf插件123import Perf from &apos;react-addons-perf&apos; // ES6var Perf = require(&apos;react-addons-perf&apos;) // ES5 with npmvar Perf = React">
<meta name="twitter:image" content="http://zhangxinmiao.com/2017/02/21/betterreact/0.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>React 性能优化初探</title>
    <!-- styles -->
    <link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/lib/meslo-LG/styles.css">
    <link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    
    <!-- jquery -->
    <script src="/lib/jquery/jquery.min.js"></script>
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://github.com/ZhangXinmiao">Projects</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://zhangxinmiao.com/2017/02/21/betterreact/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://zhangxinmiao.com/2017/02/21/betterreact/&text=React 性能优化初探"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://zhangxinmiao.com/2017/02/21/betterreact/&title=React 性能优化初探"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://zhangxinmiao.com/2017/02/21/betterreact/&is_video=false&description=React 性能优化初探"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=React 性能优化初探&body=Check out this article: http://zhangxinmiao.com/2017/02/21/betterreact/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://zhangxinmiao.com/2017/02/21/betterreact/&title=React 性能优化初探"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://zhangxinmiao.com/2017/02/21/betterreact/&title=React 性能优化初探"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://zhangxinmiao.com/2017/02/21/betterreact/&title=React 性能优化初探"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://zhangxinmiao.com/2017/02/21/betterreact/&title=React 性能优化初探"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://zhangxinmiao.com/2017/02/21/betterreact/&name=React 性能优化初探&description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#性能指标工具React-Perf"><span class="toc-number">1.</span> <span class="toc-text">性能指标工具React Perf</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-下载-Perf-插件"><span class="toc-number">1.1.</span> <span class="toc-text">1.下载 Perf 插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-利用-Perf-提供的工具函数"><span class="toc-number">1.2.</span> <span class="toc-text">2.利用 Perf 提供的工具函数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#先看一个例子"><span class="toc-number">2.</span> <span class="toc-text">先看一个例子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#思考：这种情况发生的原因是什么？"><span class="toc-number">3.</span> <span class="toc-text">思考：这种情况发生的原因是什么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#得出优化思路"><span class="toc-number">4.</span> <span class="toc-text">得出优化思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#从一个稍复杂的例子下手"><span class="toc-number">5.</span> <span class="toc-text">从一个稍复杂的例子下手</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#方法一：shuoldComponentUpdate-深拷贝"><span class="toc-number">6.</span> <span class="toc-text">方法一：shuoldComponentUpdate + 深拷贝</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#方法二：shuoldComponentUpdate-Immutable-js"><span class="toc-number">7.</span> <span class="toc-text">方法二：shuoldComponentUpdate + Immutable.js</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#方案三：PureComponent-Immutable-js"><span class="toc-number">8.</span> <span class="toc-text">方案三：PureComponent + Immutable.js</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#关于Immutable"><span class="toc-number">9.</span> <span class="toc-text">关于Immutable</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#几点注意"><span class="toc-number">10.</span> <span class="toc-text">几点注意</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结"><span class="toc-number">11.</span> <span class="toc-text">总结</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        React 性能优化初探
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">ZhangXinmiao's blog</span>
      </span>
      
    <div class="postdate">
        <time datetime="2017-02-21T15:06:48.000Z" itemprop="datePublished">2017-02-21</time>
    </div>


      
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/react/">react</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h3 id="性能指标工具React-Perf"><a href="#性能指标工具React-Perf" class="headerlink" title="性能指标工具React Perf"></a>性能指标工具React Perf</h3><p>React 官方为我们提供的性能指标工具 Perf (只适用于开发模式)</p>
<p>我们有两种方式使用它</p>
<p>ps:两种方式都需要在项目<a href="https://facebook.github.io/react/docs/perf.html" target="_blank" rel="external">Perf</a>插件<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> Perf <span class="keyword">from</span> <span class="string">'react-addons-perf'</span> <span class="comment">// ES6</span></div><div class="line"><span class="keyword">var</span> Perf = <span class="built_in">require</span>(<span class="string">'react-addons-perf'</span>) <span class="comment">// ES5 with npm</span></div><div class="line"><span class="keyword">var</span> Perf = React.addons.Perf; <span class="comment">// ES5 with react-with-addons.js</span></div></pre></td></tr></table></figure></p>
<h4 id="1-下载-Perf-插件"><a href="#1-下载-Perf-插件" class="headerlink" title="1.下载 Perf 插件"></a>1.下载 <a href="https://chrome.google.com/webstore/detail/react-perf/hacmcodfllhbnekmghgdlplbdnahmhmm" target="_blank" rel="external">Perf 插件</a></h4><p>在控制台中直接操作</p>
<p><img src="/2017/02/21/betterreact/0.png" alt="logo"></p>
<h4 id="2-利用-Perf-提供的工具函数"><a href="#2-利用-Perf-提供的工具函数" class="headerlink" title="2.利用 Perf 提供的工具函数"></a>2.利用 Perf 提供的工具函数</h4><p><img src="/2017/02/21/betterreact/1.png" alt="logo"></p>
<h3 id="先看一个例子"><a href="#先看一个例子" class="headerlink" title="先看一个例子"></a>先看一个例子</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Son</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span>(props) &#123;</div><div class="line">    <span class="keyword">super</span>(props);</div><div class="line">  &#125;</div><div class="line">  render() &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"我也render了"</span>);</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      &lt;div&gt;hello world~&lt;/div&gt;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dad</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span>(props) &#123;</div><div class="line">    <span class="keyword">super</span>(props);</div><div class="line">    <span class="keyword">this</span>.state = &#123;<span class="attr">count</span>: <span class="number">1</span>&#125;;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  render() &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"我render了!"</span>);</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      &lt;div&gt;</div><div class="line">        &lt;Son&gt;&lt;/Son&gt;</div><div class="line">        &lt;button</div><div class="line">          onClick=&#123;() =&gt; this.setState(state =&gt; (&#123;count: state.count + 1&#125;))&#125;&gt;</div><div class="line">          Count: &#123;this.state.count&#125;</div><div class="line">        &lt;/button&gt;</div><div class="line">      &lt;/div&gt;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"> ReactDOM.render(&lt;Dad /&gt;, document.getElementById('container'))</div></pre></td></tr></table></figure>
<p>打开控制台，可以看到这样的效果，按下按钮后，Son 组件每次都会重新 render ，然而对于我们来说，Son 组件是没有变化的，是不需要重新 render 的</p>
<p><img src="/2017/02/21/betterreact/2.gif" alt="logo"></p>
<p>最优的情况是我们只希望重新渲染需要的部分，但事实看来并非如此</p>
<p><img src="/2017/02/21/betterreact/3.png" alt="logo"></p>
<h3 id="思考：这种情况发生的原因是什么？"><a href="#思考：这种情况发生的原因是什么？" class="headerlink" title="思考：这种情况发生的原因是什么？"></a>思考：这种情况发生的原因是什么？</h3><p>我们可以在React代码中找到shouldComponentUpdate的部分</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">shouldComponentUpdate: <span class="function"><span class="keyword">function</span>(<span class="params">nextProps, nextState</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>结合下图，的出这样的信息：组件重新渲染之前调用shouldComponentUpdate，判断组件的props和state，若其中一者变化，函数返回trus,根据diff算法的结果进行rerender；都没有变化，就返回false，表示不需要渲染从代码看来，shouldComponentUpdate默认返回true，这就造成了不需要重新渲染的组件也会渲染的情况</p>
<p><img src="/2017/02/21/betterreact/4.jpg" alt="logo"></p>
<p>继续看代码，找到执行 props 和 state 对比的地方</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (inst.shouldComponentUpdate) &#123;</div><div class="line">    <span class="comment">//如果shouldComponentUpdate方法被重写</span></div><div class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</div><div class="line">        shouldUpdate = measureLifeCyclePerf(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="keyword">return</span> inst.shouldComponentUpdate(nextProps, nextState, nextContext);</div><div class="line">        &#125;, <span class="keyword">this</span>._debugID, <span class="string">'shouldComponentUpdate'</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        shouldUpdate = inst.shouldComponentUpdate(nextProps, nextState, nextContext);</div><div class="line">    &#125;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">//如果没有重写，利用shallowEqual函数进行对比工作</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>._compositeType === CompositeTypes.PureClass) &#123;</div><div class="line">        shouldUpdate = !shallowEqual(prevProps, nextProps) || !shallowEqual(inst.state, nextState);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>shallowEqual 实际上来自这里 <a href="https://github.com/facebook/fbjs/blob/master/packages/fbjs/src/core/shallowEqual.js" target="_blank" rel="external">shallowEqual源码</a></p>
<p>代码如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//是不是绝对的相等</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">is</span>(<span class="params">x: mixed, y: mixed</span>): <span class="title">boolean</span> </span>&#123;</div><div class="line">  <span class="comment">// SameValue algorithm</span></div><div class="line">  <span class="keyword">if</span> (x === y) &#123; <span class="comment">// Steps 1-5, 7-10</span></div><div class="line">    <span class="comment">// Steps 6.b-6.e: +0 != -0</span></div><div class="line">    <span class="comment">// Added the nonzero y check to make Flow happy, but it is redundant</span></div><div class="line">    <span class="keyword">return</span> x !== <span class="number">0</span> || y !== <span class="number">0</span> || <span class="number">1</span> / x === <span class="number">1</span> / y;</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">// Step 6.a: NaN == NaN</span></div><div class="line">    <span class="keyword">return</span> x !== x &amp;&amp; y !== y;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">shallowEqual</span>(<span class="params">objA: mixed, objB: mixed</span>): <span class="title">boolean</span> </span>&#123;</div><div class="line"><span class="comment">//如果是绝对的相等，返回true</span></div><div class="line">  <span class="keyword">if</span> (is(objA, objB)) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">  &#125;</div><div class="line"><span class="comment">//带比较的二者是null或者类型不是对象，返回false</span></div><div class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> objA !== <span class="string">'object'</span> || objA === <span class="literal">null</span> ||</div><div class="line">      <span class="keyword">typeof</span> objB !== <span class="string">'object'</span> || objB === <span class="literal">null</span>) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">  &#125;</div><div class="line"> <span class="comment">//以下为处理对象的部分</span></div><div class="line">  <span class="keyword">const</span> keysA = <span class="built_in">Object</span>.keys(objA);</div><div class="line">  <span class="keyword">const</span> keysB = <span class="built_in">Object</span>.keys(objB);</div><div class="line"><span class="comment">//比较对象的key数组长度,不同，返回false</span></div><div class="line">  <span class="keyword">if</span> (keysA.length !== keysB.length) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">  &#125;</div><div class="line"><span class="comment">//可以看到，在比较对象A和对象B的时候，只比较的对象的第一层的相等情况，也就是说，对于复杂的嵌套是无法返回正确的结果的</span></div><div class="line">  <span class="comment">// Test for A's keys different from B.</span></div><div class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; keysA.length; i++) &#123;</div><div class="line">    <span class="keyword">if</span> (</div><div class="line">      !hasOwnProperty.call(objB, keysA[i]) ||</div><div class="line">      !is(objA[keysA[i]], objB[keysA[i]])</div><div class="line">    ) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = shallowEqual;</div></pre></td></tr></table></figure>
<p>可以看出，shallowEqual 实际上是一个“浅比较”，也就是说，在 props 或者 state 是多层嵌套的复杂的对象，会给出错误的结果，这就可能导致应该重新渲染的部分没有渲染的问题</p>
<h3 id="得出优化思路"><a href="#得出优化思路" class="headerlink" title="得出优化思路"></a>得出优化思路</h3><p>根据以上的结论，我们想要减少无用的渲染次数，可以在如何让 shouldComponentUpdate 在无需重新渲染时返回值为 false 上下手</p>
<h3 id="从一个稍复杂的例子下手"><a href="#从一个稍复杂的例子下手" class="headerlink" title="从一个稍复杂的例子下手"></a>从一个稍复杂的例子下手</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">List</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span></span>&#123;</div><div class="line">    <span class="keyword">constructor</span>(props) &#123;</div><div class="line">        <span class="keyword">super</span>(props);</div><div class="line">        <span class="comment">// 构造一个2000个数据的数组</span></div><div class="line">        <span class="keyword">let</span> dataArr = [];</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">2000</span>; i++)&#123;</div><div class="line">            <span class="keyword">let</span> checked = <span class="built_in">Math</span>.random() &lt; <span class="number">0.5</span>;</div><div class="line">            dataArr.push(&#123;</div><div class="line">                <span class="attr">name</span>: i,</div><div class="line">                <span class="attr">checked</span>: checked</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">this</span>.state = &#123;</div><div class="line">            <span class="attr">list</span>: dataArr</div><div class="line">        &#125;;</div><div class="line"></div><div class="line">        <span class="keyword">this</span>.toggleChecked = <span class="keyword">this</span>.toggleChecked.bind(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 对数据的状态进行变更</span></div><div class="line">    toggleChecked(event) &#123;</div><div class="line">        <span class="keyword">let</span> checked = event.target.checked;</div><div class="line">        <span class="keyword">let</span> index = event.target.getAttribute(<span class="string">"data-index"</span>);</div><div class="line">        <span class="keyword">let</span> list = <span class="keyword">this</span>.state.list;</div><div class="line">        list[index].checked = checked;</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.setState(&#123;list&#125;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    render()&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">"我render了！"</span>);</div><div class="line">        <span class="comment">// 将数组的数据渲染出来</span></div><div class="line">        <span class="keyword">return</span> (</div><div class="line">            &lt;ul&gt;</div><div class="line">                &#123;this.state.list.map((data, index)=&gt;&#123;</div><div class="line">                    return (</div><div class="line">                        &lt;ListItem data=&#123;data&#125;</div><div class="line">                            index=&#123;index&#125; key=&#123;data.name&#125;</div><div class="line">                            toggleChecked=&#123;this.toggleChecked&#125;</div><div class="line">                        /&gt;</div><div class="line">                    )</div><div class="line">                &#125;)&#125;</div><div class="line">            &lt;/ul&gt;</div><div class="line">        )</div><div class="line">    &#125;</div><div class="line"> &#125;;</div><div class="line">// 代表每一个子组件</div><div class="line">class ListItem extends React.Component&#123;</div><div class="line">    constructor(props) &#123;</div><div class="line">      super(props);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    render() &#123;</div><div class="line">        let data = this.props.data;</div><div class="line">        let index = this.props.index;</div><div class="line"></div><div class="line">        console.log("编号" + index + "render了");</div><div class="line"></div><div class="line">        // checkbox选择框是一个受限组件，用数据来决定它是否选中</div><div class="line">        return (</div><div class="line">            &lt;li&gt;</div><div class="line">                &lt;input type="checkbox" key=&#123;index&#125;</div><div class="line">                        data-index=&#123;index&#125;           </div><div class="line">                        checked=&#123;data.checked&#125;</div><div class="line">                        onChange=&#123;this.props.toggleChecked&#125;/&gt;</div><div class="line">                &lt;span&gt;&#123;index&#125;&lt;/span&gt;</div><div class="line">            &lt;/li&gt;</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">export default List;</div></pre></td></tr></table></figure>
<p>一个有2000个 checkbox 的列表，props 和 state 中有较为复杂的对象</p>
<p>我们用这个例子来做性能优化实验</p>
<p><img src="/2017/02/21/betterreact/5.gif" alt="logo"></p>
<p><img src="/2017/02/21/betterreact/6.png" alt="logo"></p>
<p>优化前的效果</p>
<p>最优的情况，只有被点击的1989号被重新渲染</p>
<h3 id="方法一：shuoldComponentUpdate-深拷贝"><a href="#方法一：shuoldComponentUpdate-深拷贝" class="headerlink" title="方法一：shuoldComponentUpdate + 深拷贝"></a>方法一：shuoldComponentUpdate + 深拷贝</h3><p>现在试着利用 shuoldComponentUpdate 进行优化</p>
<p>加入以下代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">shouldComponentUpdate(nextProps) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.props.data.checked !== nextProps.data.checked;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>加入后运行 点击编号1989的 checkbook ，发现并没有重新渲染1989号节点，试着把 this.props 和 nextprops 打印出来看看</p>
<p><img src="/2017/02/21/betterreact/7.png" alt="logo"></p>
<p>看到改变前和改变后是一样的，出现这种情况，可能是常见的引用类型引起的问题，每一次改动都是同一指针指向同一内存，数据改变是同步的。我们可以用深拷贝的方式解决这个问题</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> list = <span class="built_in">JSON</span>.parse(<span class="built_in">JSON</span>.stringify(<span class="keyword">this</span>.state.list));</div></pre></td></tr></table></figure>
<p><img src="/2017/02/21/betterreact/8.png" alt="logo"></p>
<p>果然，深拷贝结合 shouldComponentUpdate 能够帮助我们解决问题，这样，就只有被点击的节点重新 render 了，看一下 perf 中的数据</p>
<p><img src="/2017/02/21/betterreact/9.png" alt="logo"></p>
<p>大幅度的减少了无用的渲染次数</p>
<h3 id="方法二：shuoldComponentUpdate-Immutable-js"><a href="#方法二：shuoldComponentUpdate-Immutable-js" class="headerlink" title="方法二：shuoldComponentUpdate + Immutable.js"></a>方法二：shuoldComponentUpdate + Immutable.js</h3><p>React 官方为我们提供的<a href="http://reactjs.cn/react/docs/advanced-performance.html" target="_blank" rel="external">性能优化方案</a>中，有一项是在项目中接入 Immutable.js。</p>
<p>Immutable.js 是什么，我们能用它来做什么呢？</p>
<p><a href="https://github.com/facebook/immutable-js" target="_blank" rel="external">Immutable-js</a>是一个由Lee Byron编写的Javascript的数据类型库，现在已经被Facebook开源了。它通过 结构共享 的方式提供了一个 持久不可变的 的集合。让我们来看看这个到底是什么东西。</p>
<ul>
<li>不可变：一旦被创建，一个集合不能被其他内容所改变</li>
<li>持久性：新的集合可以由之前的集合创建出来，或者由一个可变的数据创建。当新的集合被创建出来，原始的集合依然有效。</li>
<li>结构共享：新的集合会尽可能的复用之前集合内的内容。减少重复复制来提高性能。如果新集合和原来的集合是相等的，则会直接把之前的集合返回给新集合。</li>
</ul>
<p>不可变的特性让跟踪变化变得简单；每次改变总是会产生新的一个对象，所以。我们只需要判断一下它们引用是否相同即可。举个例子，下面是常规的Javascript的写法：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> x = &#123; <span class="attr">foo</span>: <span class="string">"bar"</span> &#125;;</div><div class="line"><span class="keyword">var</span> y = x;</div><div class="line">y.foo = <span class="string">"baz"</span>;</div><div class="line">x === y; <span class="comment">// true</span></div></pre></td></tr></table></figure></p>
<p>尽管y已经被更改了，但是它的引用还是和x是一致的。所以他们两个进行对比，始终会返回true。所以，这样的操作应该要用immutable-js来完成：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> SomeRecord = Immutable.Record(&#123; <span class="attr">foo</span>: <span class="literal">null</span> &#125;);</div><div class="line"><span class="keyword">var</span> x = <span class="keyword">new</span> SomeRecord(&#123; <span class="attr">foo</span>: <span class="string">'bar'</span>  &#125;);</div><div class="line"><span class="keyword">var</span> y = x.set(<span class="string">'foo'</span>, <span class="string">'baz'</span>);</div><div class="line">x === y; <span class="comment">// false</span></div></pre></td></tr></table></figure>
<p>在这样的情况中，当我们改变了x里的内容，会返回给我们一个新的引用，我们可以安全地假定x已经改变。</p>
<p>以上是摘自React文档的内容,也就是说，每次我们利用Immutable生成的数据都是新的</p>
<p>根据这种情况 修改代码如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">List</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span></span>&#123;</div><div class="line">    <span class="keyword">constructor</span>(props) &#123;</div><div class="line">        <span class="keyword">super</span>(props);</div><div class="line">        <span class="comment">// 构造一个2000个数据的数组</span></div><div class="line">        <span class="keyword">let</span> dataArr = [];</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">2000</span>; i++)&#123;</div><div class="line">            <span class="keyword">let</span> checked = <span class="built_in">Math</span>.random() &lt; <span class="number">0.5</span>;</div><div class="line">            dataArr.push(&#123;</div><div class="line">                <span class="attr">name</span>: i,</div><div class="line">                <span class="attr">checked</span>: checked</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">this</span>.state = &#123;</div><div class="line">            <span class="attr">list</span>: Immutable.fromJS(dataArr)</div><div class="line">        &#125;;</div><div class="line">        <span class="keyword">this</span>.toggleChecked = <span class="keyword">this</span>.toggleChecked.bind(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 对数据的状态进行变更</span></div><div class="line">    toggleChecked(event) &#123;</div><div class="line">        <span class="keyword">let</span> checked = event.target.checked;</div><div class="line">        <span class="keyword">let</span> index = event.target.getAttribute(<span class="string">"data-index"</span>);</div><div class="line">        <span class="keyword">let</span> list = <span class="keyword">this</span>.state.list.setIn([index, <span class="string">"checked"</span>], checked);</div><div class="line">        <span class="keyword">this</span>.setState(&#123;list&#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    render()&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">"我render了！"</span>);</div><div class="line">        <span class="comment">// 将数组的数据渲染出来</span></div><div class="line">        <span class="keyword">return</span> (</div><div class="line">            &lt;ul&gt;</div><div class="line">                &#123;this.state.list.map((data, index)=&gt;&#123;</div><div class="line">                    return (</div><div class="line">                        &lt;ListItem data=&#123;data&#125;</div><div class="line">                            index=&#123;index&#125; key=&#123;data.name&#125;</div><div class="line">                            toggleChecked=&#123;this.toggleChecked&#125;</div><div class="line">                        /&gt;</div><div class="line">                    )</div><div class="line">                &#125;)&#125;</div><div class="line">            &lt;/ul&gt;</div><div class="line">        )</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">// 代表每一个子组件</div><div class="line">class ListItem extends React.Component&#123;</div><div class="line">    constructor(props) &#123;</div><div class="line">      super(props);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    shouldComponentUpdate(nextProps) &#123;</div><div class="line">        return this.props.data !== nextProps.data;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    render() &#123;</div><div class="line">        let data = this.props.data;</div><div class="line">        let index = this.props.index;</div><div class="line"></div><div class="line">        console.log("编号" + index + "render了");</div><div class="line"></div><div class="line">        // checkbox选择框是一个受限组件，用数据来决定它是否选中</div><div class="line">        return (</div><div class="line">            &lt;li&gt;</div><div class="line">                &lt;input type="checkbox" key=&#123;index&#125; data-index=&#123;index&#125; checked=&#123;data.get("checked")&#125; onChange=&#123;this.props.toggleChecked&#125;/&gt;</div><div class="line">                &lt;span&gt;&#123;index&#125;&lt;/span&gt;</div><div class="line">            &lt;/li&gt;</div><div class="line">        )</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">export default List;</div></pre></td></tr></table></figure>
<p>改动点在于一开始就另 state 是不可变的数据，取数据时用 Immutable 提供的 get 配合</p>
<p>运行结果如下,在 shouldComponentUpdate 中比较 props.data 的引用，引用变了，则重新 render</p>
<p><img src="/2017/02/21/betterreact/10.gif" alt="logo"></p>
<p>既然深拷贝能够解决问题 问什么还要引入 Immutable 呢？</p>
<p>深拷贝比较耗费性能和内存，甚至我们也可以通过在 shouldComponentUpdat较(需要写递归)解决上面的问题，但是这些做法都是不利于我们做性能Immutable 利用了一种叫做 Structural Sharing（结构共享）的技术，个节点发生变化，只修改这个节点和受它影响的父节点，其它节点则进行共享。表现了这一过程(图片来自网络)</p>
<p><img src="/2017/02/21/betterreact/11.gif" alt="logo"></p>
<h3 id="方案三：PureComponent-Immutable-js"><a href="#方案三：PureComponent-Immutable-js" class="headerlink" title="方案三：PureComponent + Immutable.js"></a>方案三：PureComponent + Immutable.js</h3><p>React 为我们提供了 PureComponent 纯组件来规避反复写 shouldComponentUpdate 来优化的问题</p>
<p>那么什么是纯组件呢？</p>
<p>如果我们的 React 组件的 render 函数在接收相同的 props 和 state 的情况下，能够渲染出同样的结果，我们称之为一个“纯”的组件，我们可以用 React.PureComponent 来进行优化，纯组件的概念实际上借用了函数式编程的概念。</p>
<p>代码方面我们只需把原来的 extend React.Component 改写为 React.PureComponent ，将 state 改为 Immutable 的数据即可，运行效果和方法二一样</p>
<p>通过Perf查看性能数据</p>
<p><img src="/2017/02/21/betterreact/12.png" alt="logo"></p>
<p>从上面的 React 中对比 props 和 state 处的代码中可以看出，当我们没有在组件中手动添加 shouldComponentUpdate 时，进入下面的 else 分支，利用 shallowCompare 进行比较，虽然 shallowCompare 是浅比较，但是借助于 Immutable 数据，我们只需比较前后 props 的引用即可</p>
<h3 id="关于Immutable"><a href="#关于Immutable" class="headerlink" title="关于Immutable"></a>关于Immutable</h3><p>在 <a href="https://github.com/facebook/immutable-js" target="_blank" rel="external">Immutable官网</a> 上打开 chrome 调试工具就可以调用 Immutable 的方法了</p>
<ul>
<li>Immutable 提供了几种不可变的数据类型，包括 List (对应数组)、Map (对应对象key-value)等，也有 fromJS 的方法,该方法可以把复杂的js对象“从里到外”全部变成不可变数据。也就是说，fromJS 与 Map 的区别就在于Map 只是对对象的第一层进行操作，里层嵌套的还是 js对象，而 fromJS 把对象中的 key-value 形式变成 Map，数组变成 List。对比效果如下图</li>
</ul>
<p><img src="/2017/02/21/betterreact/13.png" alt="logo"><br><img src="/2017/02/21/betterreact/14.png" alt="logo"></p>
<ul>
<li>嵌套的不可变数据的取值方法</li>
</ul>
<p><img src="/2017/02/21/betterreact/15.png" alt="logo"></p>
<ul>
<li>现有项目不建议引入，原因：(1) Immutable有一定的学习成本；(2) 改动较大，改动点较多；(3) PC 端目前并未暴露出使用性能上的问题</li>
</ul>
<h3 id="几点注意"><a href="#几点注意" class="headerlink" title="几点注意"></a>几点注意</h3><ul>
<li>避免在组件中传入不必要的多余的 props ，慎用 …this.props，在尝试优化时，时常发现因为多余的props变化造成了重新render</li>
<li>注意 dom 节点的 key 属性的运用，有时不添加 key 可能会导致错误</li>
<li>…</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>React 的 Virtual Dom 为我们提升了一部分的性能，就目前我们的 OA 系统使用情况，并没有发现有什么性能瓶颈，不确定的是在移动端的环境下，重复渲染是否会造成卡顿，经过一番调研，发现已经有一些团队已经在进行 React 的优化工作，并有了一些成型的优化方案，在了解了原理之后，我觉得优化思路实际上是比较多种多样的，我们可以引入 Immutable 解决问题，如果考虑到减包的问题( Immutable 压缩后有50k)，也已经有一些机智的程序员们写出了相对较小的 “Immutable“(<a href="https://github.com/rtfeldman/seamless-immutable" target="_blank" rel="external">seamless-immutable</a>) ，甚至我们还可以自己造一个。</p>

  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://github.com/ZhangXinmiao">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#性能指标工具React-Perf"><span class="toc-number">1.</span> <span class="toc-text">性能指标工具React Perf</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-下载-Perf-插件"><span class="toc-number">1.1.</span> <span class="toc-text">1.下载 Perf 插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-利用-Perf-提供的工具函数"><span class="toc-number">1.2.</span> <span class="toc-text">2.利用 Perf 提供的工具函数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#先看一个例子"><span class="toc-number">2.</span> <span class="toc-text">先看一个例子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#思考：这种情况发生的原因是什么？"><span class="toc-number">3.</span> <span class="toc-text">思考：这种情况发生的原因是什么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#得出优化思路"><span class="toc-number">4.</span> <span class="toc-text">得出优化思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#从一个稍复杂的例子下手"><span class="toc-number">5.</span> <span class="toc-text">从一个稍复杂的例子下手</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#方法一：shuoldComponentUpdate-深拷贝"><span class="toc-number">6.</span> <span class="toc-text">方法一：shuoldComponentUpdate + 深拷贝</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#方法二：shuoldComponentUpdate-Immutable-js"><span class="toc-number">7.</span> <span class="toc-text">方法二：shuoldComponentUpdate + Immutable.js</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#方案三：PureComponent-Immutable-js"><span class="toc-number">8.</span> <span class="toc-text">方案三：PureComponent + Immutable.js</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#关于Immutable"><span class="toc-number">9.</span> <span class="toc-text">关于Immutable</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#几点注意"><span class="toc-number">10.</span> <span class="toc-text">几点注意</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结"><span class="toc-number">11.</span> <span class="toc-text">总结</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://zhangxinmiao.com/2017/02/21/betterreact/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://zhangxinmiao.com/2017/02/21/betterreact/&text=React 性能优化初探"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://zhangxinmiao.com/2017/02/21/betterreact/&title=React 性能优化初探"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://zhangxinmiao.com/2017/02/21/betterreact/&is_video=false&description=React 性能优化初探"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=React 性能优化初探&body=Check out this article: http://zhangxinmiao.com/2017/02/21/betterreact/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://zhangxinmiao.com/2017/02/21/betterreact/&title=React 性能优化初探"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://zhangxinmiao.com/2017/02/21/betterreact/&title=React 性能优化初探"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://zhangxinmiao.com/2017/02/21/betterreact/&title=React 性能优化初探"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://zhangxinmiao.com/2017/02/21/betterreact/&title=React 性能优化初探"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://zhangxinmiao.com/2017/02/21/betterreact/&name=React 性能优化初探&description="><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick='$("#toc-footer").toggle();return false;'><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick='$("#share-footer").toggle();return false;'><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick='$("#nav-footer").toggle();return false;'><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2017 张鑫淼
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://github.com/ZhangXinmiao">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    <script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-86660611-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Disqus Comments -->


</body>
</html>
